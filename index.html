<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Traffic Ease – 待ち時間のおすすめプロトタイプ</title>
<style>
  :root{
    --bg:#0f172a;
    --card:#111827;
    --muted:#94a3b8;
    --accent:#60a5fa;
    --good:#34d399;
    --bad:#f87171;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto;
    background: radial-gradient(1200px 800px at 10% -10%, #1e293b 10%, transparent 60%) no-repeat,
                radial-gradient(1000px 700px at 110% 10%, #0b1324 10%, transparent 60%) no-repeat,
                var(--bg);
    color:#e5e7eb; min-height:100vh;
  }
  header{
    max-width:1100px;
    margin:40px auto 20px;
    padding:0 16px
  }
  h1{
    font-weight:700;
    letter-spacing:.2px;
    margin:0 0 6px
  }
  .sub{
    color:var(--muted);
    font-size:14px
  }

  .wrap{
    max-width:1100px;
    margin:0 auto;
    padding:0 16px 40px;
    display:grid;gap:16px;
    grid-template-columns:360px 1fr
  }

  .panel{
    background: #0b1220d9;
    border:1px solid #1f2937; border-radius:16px; padding:16px;
    backdrop-filter: blur(6px);
  }
  .panel h2
  {margin:4px 0 12px;
    font-size:16px;
    color:#cbd5e1;
    font-weight:600
  }

  .row{
    display:flex;
    gap:8px;
    align-items:center;
    margin:8px 0
  }
  .row input[type="number"]{width:110px}
  input,select,button{
    font:inherit;
    color:#e5e7eb;
    background:#0b1220;
    border:1px solid #1f2937;
    border-radius:10px;
    padding:10px 12px;
    outline:none;
  }
  input::placeholder{color:#64748b}
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border:none}
  button.secondary{background:#0b1220;border-color:#334155}
  button.ghost{background:transparent;border-color:#334155}
  button:disabled{opacity:.5;cursor:not-allowed}

  .progress{
    margin:10px 0 6px;
    height:14px;
    background:#0b1220;
    border:1px solid #1f2937;
    border-radius:999px;
    overflow:hidden;
  }
  .bar{
    height:100%; width:0%;
    background: linear-gradient(90deg,#22d3ee,#60a5fa,#34d399);
    transition: width .3s ease;
  }
  .time-row{
    display:flex;
    justify-content:space-between;
    color:#94a3b8;
    font-size:13px
  }

  .grid{
    display:grid;
    gap:12px
  }

  .card{
    background: #0b1220;
    border:1px solid #1f2937;
    border-radius:14px;
    padding:14px;
  }

  .card h3{
    margin:0 0 6px;
    font-size:16px
  }
  .meta{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    color:#94a3b8;
    font-size:12px
  }
  .chip{
    background:#0b1324;
    border:1px solid #1f2937;
    border-radius:999px;
    padding:4px 8px
  }
  .ok{color:var(--good)} .warn{color:var(--bad)}
  
  .empty{padding:20px;
    text-align:center;
    color:#94a3b8}

  .footer-msg{
    margin-top:10px;
    color:#a3e635
    }
</style>
</head>
<body>
  <header>
    <h1>Traffic Ease</h1>
    <div class="sub">「待ち時間も自分の時間に」— 残り時間とおおよその位置を入力すると、今できるアクティビティをおすすめします。</div>
  </header>

  <div class="wrap">
    <section class="panel" id="controller">
      <h2>1) 残り時間・進行</h2>
      <div class="row">
        <input id="minutes" type="number" min="1" step="1" placeholder="残り時間（分）" />
        <button id="start" class="primary">開始</button>
      </div>

      <div class="progress" aria-label="残り時間プログレスバー">
        <div id="bar" class="bar"></div>
      </div>
      <div class="time-row">
        <div>残り時間: <span id="remain-text">00:00</span></div>
        <div>合計: <span id="total-text">0分</span></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="pause"  class="secondary" disabled>一時停止</button>
        <button id="resume" class="ghost"     disabled>再開</button>
        <button id="reset"  class="ghost"     disabled>リセット</button>
      </div>
      <div id="done-msg" class="footer-msg" hidden>⏰ 時間になりました。まもなく到着/出発のタイミングです！</div>
    </section>

    <section class="panel">
      <h2>2) 位置（おおよそ）・アクティビティ提案</h2>
      <div class="row">
        <input id="location-input" list="loc-samples" placeholder="だいたいの場所を入力（例: 新宿, 渋谷 …）" />
        <datalist id="loc-samples">
          <option value="新宿"></option>
          <option value="渋谷"></option>
          <option value="八王子"></option>
          <option value="横浜"></option>
          <option value="多摩センター"></option>
        </datalist>
        <button id="apply-loc" class="secondary">適用</button>
      </div>
      <div class="sub" style="margin-top:4px">※ GPSは使用しません。サンプルデータから近隣施設を提案します。</div>

      <div style="margin-top:14px"></div>
      <h2>おすすめ</h2>
      <div id="cards" class="grid"></div>
    </section>
  </div>

<script>
const baseActivities = [
  // {
  //   id:'cafe-enjoy',
  //   title:'カフェでコーヒーを楽しむ',
  //   kind:'カフェ',
  //   stayMin: 20,          // 滞在
  //   travelMin: 7,         // 片道の想定移動（位置不明時の仮）
  //   desc:'近くのカフェで温かい一杯で気持ちを落ち着かせましょう。'
  // },
  {
    id:'bakery',
    title:'ベーカリーでさっと購入',
    kind:'グルメ',
    stayMin: 10,
    travelMin: 6,
    desc:'列が短い店を選んで素早く立ち寄り。'
  },
  {
    id:'bookstore',
    title:'書店で新刊をざっとチェック',
    kind:'カルチャー',
    stayMin: 15,
    travelMin: 8,
    desc:'表紙を眺めるだけでも新しい刺激に。'
  },
  {
    id:'conbini',
    title:'コンビニで必要な物を補充',
    kind:'生活',
    stayMin: 8,
    travelMin: 4,
    desc:'水/ティッシュ/充電ケーブルなどを素早くチェック。'
  },
  {
    id:'walk',
    title:'周辺を軽く散歩',
    kind:'ライト',
    stayMin: 12,
    travelMin: 0,
    desc:'遠くへ行かず、一回りして戻る短い散歩。'
  },
];

const areaFacilities = {
  '新宿': [
    { name:'ドトールコーヒー',   type:'カフェ',   walkMin:5, stayMin:20, distanceKm:0.35 },
    { name:'スターバックス西新宿', type:'カフェ',   walkMin:7, stayMin:25, distanceKm:0.5 },
    { name:'新宿中央公園を散歩',   type:'ライト',   walkMin:6, stayMin:12, distanceKm:0.6 },
  ],
  '渋谷': [
    { name:'ブルーボトル渋谷',   type:'カフェ',   walkMin:8, stayMin:20, distanceKm:0.7 },
    { name:'TSUTAYA書店',       type:'カルチャー', walkMin:6, stayMin:15, distanceKm:0.5 },
  ],
  '八王子': [
    { name:'スターバックス駅前', type:'カフェ',   walkMin:5, stayMin:22, distanceKm:0.4 },
    { name:'お弁当ピックアップ', type:'グルメ',   walkMin:4, stayMin:10, distanceKm:0.3 },
  ],
  '横浜': [
    { name:'横浜海辺を散策',     type:'ライト',   walkMin:9, stayMin:15, distanceKm:0.8 },
    { name:'元町カフェ',         type:'カフェ',   walkMin:10, stayMin:25, distanceKm:0.9 },
  ],
  '多摩センター': [
    { name:'ベーカリーでさっと購入', type:'グルメ', walkMin:6, stayMin:10, distanceKm:0.4 },
    { name:'小さな公園を一周',       type:'ライト', walkMin:5, stayMin:12, distanceKm:0.35 },
  ],
};

let timerId = null;
let endAt = null;
let remainingSec = 0;
let isRunning = false;
let isPaused  = false;
let totalSec  = 0;

const elMinutes   = document.getElementById('minutes');
const elStart     = document.getElementById('start');
const elPause     = document.getElementById('pause');
const elResume    = document.getElementById('resume');
const elReset     = document.getElementById('reset');
const elRemainTxt = document.getElementById('remain-text');
const elTotalTxt  = document.getElementById('total-text');
const elBar       = document.getElementById('bar');
const elDoneMsg   = document.getElementById('done-msg');

elStart.addEventListener('click', () => {
  const m = parseInt(elMinutes.value,10);
  if (isNaN(m) || m <= 0){ alert('残り時間を分単位で入力してください。'); return; }
  startTimer(m);
  refreshRecommendations(); // 開始と同時に一度計算
});
elPause .addEventListener('click', pauseTimer);
elResume.addEventListener('click', resumeTimer);
elReset .addEventListener('click', resetTimer);

function startTimer(totalMinutes){
  totalSec = Math.max(0, Math.round(totalMinutes * 60));
  remainingSec = totalSec;
  endAt = Date.now() + remainingSec * 1000;
  isRunning = true; isPaused = false;
  clearInterval(timerId);
  tick();
  timerId = setInterval(tick, 1000);
  updateTimerButtons();
  elDoneMsg.hidden = true;
}

function tick(){
  if(!isRunning || isPaused) return;
  remainingSec = Math.max(0, Math.round((endAt - Date.now())/1000));
  updateProgressUI(remainingSec);

  if(remainingSec <= 0){
    stopTimer();
    onTimerFinished();
  }
}

function pauseTimer(){
  if(!isRunning || isPaused || remainingSec<=0) return;
  isPaused = true;
  clearInterval(timerId); timerId=null;
  updateTimerButtons();
}

function resumeTimer(){
  if(!isPaused || remainingSec<=0) return;
  isPaused = false;
  endAt = Date.now() + remainingSec * 1000;
  clearInterval(timerId);
  timerId = setInterval(tick, 1000);
  updateTimerButtons();
}

function stopTimer(){
  clearInterval(timerId); timerId=null;
  isRunning = false; isPaused=false;
  updateTimerButtons();
}

function resetTimer(){
  clearInterval(timerId); timerId=null;
  remainingSec = 0; totalSec = 0;
  isRunning=false; isPaused=false;
  updateProgressUI(remainingSec);
  updateTimerButtons();
  elDoneMsg.hidden = true;
}

function updateTimerButtons(){
  elPause .disabled = !(isRunning && !isPaused && remainingSec>0);
  elResume.disabled = !(isPaused  && remainingSec>0);
  elReset .disabled = !(isRunning || remainingSec>0);
}

function updateProgressUI(remain){
  const pct = (totalSec>0) ? (remain/totalSec)*100 : 0;
  elBar.style.width = Math.max(0, Math.min(100, pct)) + '%';
  elRemainTxt.textContent = fmtTime(remain);
  elTotalTxt.textContent  = totalSec>0 ? Math.round(totalSec/60)+'分' : '0分';

  if (isRunning && !isPaused){
    if (remain % 5 === 0){ refreshRecommendations(); }
  }
}

function onTimerFinished(){
  elDoneMsg.hidden = false;
  refreshRecommendations();
}

/* フォーマッタ */
function fmtTime(sec){
  const m = Math.floor(sec/60), s = sec%60;
  const mm = String(m).padStart(2,'0');
  const ss = String(s).padStart(2,'0');
  return `${mm}:${ss}`;
}

let currentArea = null;

document.getElementById('apply-loc').addEventListener('click', ()=>{
  const v = (document.getElementById('location-input').value || '').trim();
  currentArea = v || null;
  refreshRecommendations(true);
});

function refreshRecommendations(showEmptyNote=false){
  const cards = document.getElementById('cards');
  const list = [];

  const remainMin = Math.max(0, Math.round(remainingSec/60));

  const facilities = areaFacilities[currentArea] || [];
  for (const f of facilities){
    const total = f.walkMin*2 + f.stayMin;
    if (total <= remainMin){
      list.push({
        title: (f.type==='' ? '' : f.name),
        subtitle: f.name,
        kind: f.type,
        roundTrip: f.walkMin*2,
        stay: f.stayMin,
        total,
        distanceKm: f.distanceKm ?? null
      });
    }
  }

  for (const a of baseActivities){
    const total = a.travelMin*2 + a.stayMin;
    if (total <= remainMin){
      list.push({
        title: a.title,
        subtitle: a.desc,
        kind: a.kind,
        roundTrip: a.travelMin*2,
        stay: a.stayMin,
        total,
        distanceKm: null
      });
    }
  }

  list.sort((x,y)=>x.total - y.total);

  if (list.length===0){
    cards.innerHTML = `<div class="empty">${showEmptyNote ? 'この地域では、現在の残り時間内で可能な提案がありません。時間を延ばすか、他の活動を試してみてください。' : '残り時間を入力して「開始」を押してください。'}</div>`;
    return;
  }

  cards.innerHTML = list.map(item=>{
    const ok = remainingSec >= item.total*60;
    return `
      <article class="card">
        <h3>${escapeHtml(item.title)}</h3>
        <div class="meta" style="margin:4px 0 8px">
          <span class="chip">${escapeHtml(item.kind)}</span>
          ${item.subtitle ? `<span class="chip">${escapeHtml(item.subtitle)}</span>`:''}
          <span class="chip">滞在 ${item.stay}分</span>
          <span class="chip">往復移動 ${item.roundTrip}分</span>
          <span class="chip">合計 ${item.total}分</span>
          ${item.distanceKm ? `<span class="chip">約 ${item.distanceKm.toFixed(1)} km</span>`:''}
        </div>
        <div class="${ok?'ok':'warn'}">${ok?'今から始めても十分です。':'時間が少し足りません。'}</div>
      </article>
    `;
  }).join('');
}

function escapeHtml(str){
  if(typeof str!=='string') return str;
  return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

refreshRecommendations();
</script>
</body>
</html>

